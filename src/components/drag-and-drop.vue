<template>
  <div class="dragAndDrop__wrapper mb-3">
    <label for="drgNdrp" class="dragAndDrop__block dragAndDrop__label relative">
      <svg class="md:block hidden" xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 54 54" fill="none">
        <g clip-path="url(#clip0_874_743)">
          <path d="M47.8719 12.4654L43.8321 8.42579V2.40026C43.8321 1.07673 42.7554 0 41.4318 0H8.26679C6.95982 0 5.89648 1.06334 5.89648 2.3703V42.1353C5.89648 43.4423 6.95982 44.5056 8.26679 44.5056H9.60751V45.8265C9.60751 47.1335 10.6708 48.1968 11.9779 48.1968H17.1198C17.5567 48.1968 17.9109 47.8427 17.9109 47.4058C17.9109 46.9688 17.5567 46.6148 17.1198 46.6148H11.9779C11.5432 46.6148 11.1895 46.2611 11.1895 45.8265V14.023C11.1895 13.5861 10.8354 13.232 10.3985 13.232C9.96167 13.232 9.60751 13.5861 9.60751 14.023V42.9236H8.26679C7.83215 42.9236 7.47852 42.5699 7.47852 42.1353V2.3703C7.47852 1.93567 7.83215 1.58203 8.26679 1.58203H41.4319C41.8831 1.58203 42.2502 1.94906 42.2502 2.40026V6.84387L39.329 3.92291C39.1806 3.77462 38.9795 3.6913 38.7697 3.6913H11.9779C10.6708 3.6913 9.60751 4.75464 9.60751 6.06161V10.3408C9.60751 10.7777 9.96167 11.1318 10.3985 11.1318C10.8354 11.1318 11.1895 10.7777 11.1895 10.3408V6.0615C11.1895 5.62686 11.5432 5.27323 11.9779 5.27323H37.9786V13.0233C37.9786 13.4601 38.3327 13.8142 38.7695 13.8143L46.5216 13.8156V45.8264C46.5216 46.261 46.1679 46.6147 45.7333 46.6147H40.6529C40.216 46.6147 39.8619 46.9687 39.8619 47.4057C39.8619 47.8426 40.216 48.1967 40.6529 48.1967H45.7333C47.0403 48.1967 48.1036 47.1334 48.1036 45.8264V13.0248C48.1036 12.815 48.0203 12.6139 47.8719 12.4654ZM39.5606 12.2324V6.39183L45.4025 12.2334L39.5606 12.2324Z" fill="#920038"/>
          <path d="M38.3375 18.5051H19.4141C18.9772 18.5051 18.623 18.8592 18.623 19.2961C18.623 19.7331 18.9772 20.0872 19.4141 20.0872H38.3375C38.7743 20.0872 39.1285 19.7331 39.1285 19.2961C39.1285 18.8592 38.7743 18.5051 38.3375 18.5051Z" fill="#920038"/>
          <path d="M38.3375 23.1702H19.4141C18.9772 23.1702 18.623 23.5243 18.623 23.9612C18.623 24.3982 18.9772 24.7523 19.4141 24.7523H38.3375C38.7743 24.7523 39.1285 24.3982 39.1285 23.9612C39.1285 23.5243 38.7743 23.1702 38.3375 23.1702Z" fill="#920038"/>
          <path d="M38.3362 27.9283H34.5977C34.1608 27.9283 33.8066 28.2824 33.8066 28.7194C33.8066 29.1563 34.1608 29.5104 34.5977 29.5104H38.3362C38.7731 29.5104 39.1272 29.1563 39.1272 28.7194C39.1272 28.2824 38.7731 27.9283 38.3362 27.9283Z" fill="#920038"/>
          <path d="M30.8762 29.5104C31.313 29.5104 31.6672 29.1563 31.6672 28.7194C31.6672 28.2824 31.313 27.9283 30.8762 27.9283H19.4141C18.9772 27.9283 18.623 28.2824 18.623 28.7194C18.623 29.1563 18.9772 29.5104 19.4141 29.5104H30.8762Z" fill="#920038"/>
          <path d="M31.7748 43.3054L29.6661 41.1967V48.8438C29.6661 49.2808 29.3119 49.6349 28.875 49.6349C28.4382 49.6349 28.084 49.2808 28.084 48.8438V41.1967L25.9753 43.3054C25.6664 43.6142 25.1655 43.6143 24.8567 43.3053C24.5478 42.9963 24.5478 42.4955 24.8567 42.1867L28.3157 38.7277C28.4702 38.5733 28.6726 38.4961 28.875 38.4961C29.0774 38.4961 29.2799 38.5733 29.4343 38.7277L32.8934 42.1867C33.2023 42.4956 33.2023 42.9964 32.8934 43.3053C32.5846 43.6142 32.0837 43.6141 31.7748 43.3054Z" fill="#920038"/>
          <path d="M28.8745 34.1307C23.3963 34.1307 18.9395 38.5874 18.9395 44.0654C18.9395 49.5432 23.3963 53.9999 28.8745 53.9999C34.3526 53.9999 38.8095 49.5432 38.8095 44.0654C38.8095 38.5874 34.3526 34.1307 28.8745 34.1307ZM28.8745 52.418C24.2687 52.418 20.5215 48.6711 20.5215 44.0655C20.5215 39.4599 24.2687 35.7129 28.8745 35.7129C33.4803 35.7129 37.2275 39.4599 37.2275 44.0655C37.2275 48.6711 33.4803 52.418 28.8745 52.418Z" fill="#920038"/>
        </g>
        <defs>
          <clipPath id="clip0_874_743">
            <rect width="54" height="54" fill="white"/>
          </clipPath>
        </defs>
      </svg>
      <span v-if="file === null">Загрузить прайс-лист, для быстрого заполнения корзины.</span>
      <span v-else>{{ file.name }}</span>
      <input id="drgNdrp" class="absolute dragAndDrop__input cursor-pointer" type="file" @change="onChange" />
    </label>
    <a href="/lk/orders/?filter_status=F" class="dragAndDrop__block dragAndDrop__history-orders">
      <svg class="md:block hidden" xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 54 54" fill="none">
        <g clip-path="url(#clip0_876_1)">
          <path d="M51.1278 2.69515H2.87234C1.28851 2.69515 0 3.98366 0 5.56748V40.9557C0 42.5395 1.28851 43.8279 2.87234 43.8279H5.23874C5.67559 43.8279 6.02975 43.4738 6.02975 43.0369C6.02975 42.6001 5.67559 42.2459 5.23874 42.2459H2.87234C2.16084 42.2459 1.58203 41.6671 1.58203 40.9557V11.6319H42.9258C43.3627 11.6319 43.7168 11.2778 43.7168 10.8409C43.7168 10.4041 43.3627 10.0499 42.9258 10.0499H1.58203V5.56748C1.58203 4.85599 2.16084 4.27718 2.87234 4.27718H51.1278C51.8392 4.27718 52.418 4.85599 52.418 5.56748V10.0499H46.652C46.215 10.0499 45.861 10.4041 45.861 10.8409C45.861 11.2778 46.215 11.6319 46.652 11.6319H52.418V40.9557C52.418 41.6672 51.8392 42.2459 51.1278 42.2459H48.7234C48.2864 42.2459 47.9324 42.6001 47.9324 43.0369C47.9324 43.4738 48.2864 43.8279 48.7234 43.8279H51.1278C52.7116 43.8279 54 42.5394 54 40.9557V5.56748C54 3.98366 52.7116 2.69515 51.1278 2.69515Z" fill="#920038"/>
          <path d="M4.41602 6.37369C3.97916 6.37369 3.625 6.72785 3.625 7.1647C3.625 7.60155 3.97916 7.95572 4.41602 7.95572H7.66371C8.10057 7.95572 8.45473 7.60155 8.45473 7.1647C8.45473 6.72785 8.10057 6.37369 7.66371 6.37369H4.41602Z" fill="#920038"/>
          <path d="M11.3555 6.37369C10.9186 6.37369 10.5645 6.72785 10.5645 7.1647C10.5645 7.60155 10.9186 7.95572 11.3555 7.95572H14.6032C15.04 7.95572 15.3942 7.60155 15.3942 7.1647C15.3942 6.72785 15.04 6.37369 14.6032 6.37369H11.3555Z" fill="#920038"/>
          <path d="M18.3164 6.37369C17.8796 6.37369 17.5254 6.72785 17.5254 7.1647C17.5254 7.60155 17.8796 7.95572 18.3164 7.95572H21.5641C22.001 7.95572 22.3551 7.60155 22.3551 7.1647C22.3551 6.72785 22.001 6.37369 21.5641 6.37369H18.3164Z" fill="#920038"/>
          <path d="M45.5968 17.1877H30.8192C29.2319 17.1877 27.8293 17.994 26.9995 19.2186C26.1698 17.994 24.7673 17.1877 23.1799 17.1877H8.40234C7.96549 17.1877 7.61133 17.5419 7.61133 17.9787V47.9409C7.61133 49.7958 9.12038 51.305 10.9754 51.305H43.0239C44.8788 51.305 46.388 49.7959 46.388 47.9409V27.7766C46.388 27.3397 46.0339 26.9856 45.597 26.9856C45.16 26.9856 44.8059 27.3397 44.8059 27.7766V45.9033H30.8192C29.661 45.9033 28.6013 46.3325 27.7906 47.0403V21.7983C27.7906 20.1283 29.1492 18.7696 30.8192 18.7696H44.8058V24.095C44.8058 24.5318 45.1599 24.886 45.5968 24.886C46.0338 24.886 46.3879 24.5318 46.3879 24.095V17.9786C46.3879 17.5419 46.0337 17.1877 45.5968 17.1877ZM9.19336 47.9409V47.4853H12.5148C12.9516 47.4853 13.3058 47.1311 13.3058 46.6943C13.3058 46.2574 12.9516 45.9033 12.5148 45.9033H9.19336V18.7697H23.18C24.85 18.7697 26.2086 20.1284 26.2086 21.7984V47.0403C25.3979 46.3326 24.3381 45.9033 23.18 45.9033H16.1667C15.7299 45.9033 15.3757 46.2574 15.3757 46.6943C15.3757 47.1311 15.7299 47.4853 16.1667 47.4853H23.18C24.5764 47.4853 25.7551 48.4353 26.1038 49.7229H10.9753C9.99271 49.7229 9.19336 48.9235 9.19336 47.9409ZM30.8192 47.4853H44.8058V47.9409C44.8058 48.9235 44.0065 49.7229 43.0238 49.7229H27.8954C28.2441 48.4353 29.4228 47.4853 30.8192 47.4853Z" fill="#920038"/>
          <path d="M12.1035 23.8851H22.273C22.71 23.8851 23.064 23.5309 23.064 23.0941C23.064 22.6572 22.71 22.3031 22.273 22.3031H12.1035C11.6667 22.3031 11.3125 22.6572 11.3125 23.0941C11.3125 23.5309 11.6667 23.8851 12.1035 23.8851Z" fill="#920038"/>
          <path d="M12.1035 28.5504H22.273C22.71 28.5504 23.064 28.1962 23.064 27.7594C23.064 27.3225 22.71 26.9684 22.273 26.9684H12.1035C11.6667 26.9684 11.3125 27.3225 11.3125 27.7594C11.3125 28.1962 11.6667 28.5504 12.1035 28.5504Z" fill="#920038"/>
          <path d="M12.1035 33.2157H22.273C22.71 33.2157 23.064 32.8615 23.064 32.4247C23.064 31.9878 22.71 31.6337 22.273 31.6337H12.1035C11.6667 31.6337 11.3125 31.9878 11.3125 32.4247C11.3125 32.8615 11.6667 33.2157 12.1035 33.2157Z" fill="#920038"/>
          <path d="M12.1035 37.881H22.273C22.71 37.881 23.064 37.5268 23.064 37.09C23.064 36.6531 22.71 36.299 22.273 36.299H12.1035C11.6667 36.299 11.3125 36.6531 11.3125 37.09C11.3125 37.5268 11.6667 37.881 12.1035 37.881Z" fill="#920038"/>
          <path d="M23.064 41.7553C23.064 41.3184 22.71 40.9643 22.273 40.9643H12.1035C11.6667 40.9643 11.3125 41.3184 11.3125 41.7553C11.3125 42.1921 11.6667 42.5463 12.1035 42.5463H22.273C22.71 42.5463 23.064 42.1921 23.064 41.7553Z" fill="#920038"/>
          <path d="M41.8921 22.3031H31.7227C31.2857 22.3031 30.9316 22.6572 30.9316 23.0941C30.9316 23.5309 31.2857 23.8851 31.7227 23.8851H41.8921C42.329 23.8851 42.6831 23.5309 42.6831 23.0941C42.6831 22.6572 42.3289 22.3031 41.8921 22.3031Z" fill="#920038"/>
          <path d="M41.8921 26.9684H31.7227C31.2857 26.9684 30.9316 27.3225 30.9316 27.7594C30.9316 28.1962 31.2857 28.5504 31.7227 28.5504H41.8921C42.329 28.5504 42.6831 28.1962 42.6831 27.7594C42.6831 27.3225 42.3289 26.9684 41.8921 26.9684Z" fill="#920038"/>
          <path d="M41.8921 31.6337H31.7227C31.2857 31.6337 30.9316 31.9878 30.9316 32.4247C30.9316 32.8615 31.2857 33.2157 31.7227 33.2157H41.8921C42.329 33.2157 42.6831 32.8615 42.6831 32.4247C42.6831 31.9878 42.3289 31.6337 41.8921 31.6337Z" fill="#920038"/>
          <path d="M41.8921 36.299H31.7227C31.2857 36.299 30.9316 36.6531 30.9316 37.09C30.9316 37.5268 31.2857 37.881 31.7227 37.881H41.8921C42.329 37.881 42.6831 37.5268 42.6831 37.09C42.6831 36.6531 42.3289 36.299 41.8921 36.299Z" fill="#920038"/>
          <path d="M41.8921 40.9643H31.7227C31.2857 40.9643 30.9316 41.3184 30.9316 41.7553C30.9316 42.1921 31.2857 42.5463 31.7227 42.5463H41.8921C42.329 42.5463 42.6831 42.1921 42.6831 41.7553C42.6831 41.3184 42.3289 40.9643 41.8921 40.9643Z" fill="#920038"/>
        </g>
        <defs>
          <clipPath id="clip0_876_1">
            <rect width="54" height="54" fill="white"/>
          </clipPath>
        </defs>
      </svg>
      История заказов: повторить или изменить
      заказ, который вы делали ранее
    </a>
  </div>
  <span class="dragAndDrop__notice mb-3">Прайс-лист должен содержать поля «Наименование» или «Артикул» и «Количество»</span>
  <div class="flex items-center w-fit cursor-pointer mb-12" @click="DownloadExample">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
      <path d="M13.5846 0H1.81836V20H18.182V4.59745L13.5846 0ZM16.9699 18.7879H3.03048V1.21212H13.0824L16.9699 5.09952V18.7879Z" fill="#191A1C"/>
      <path d="M10.6054 12.0715V6.46539H9.39329V12.0715L7.34153 10.0196L6.48438 10.8767L9.99935 14.3917L13.5143 10.8767L12.6572 10.0196L10.6054 12.0715Z" fill="#191A1C"/>
    </svg>
    <span class="dragAndDrop__download-example">Скачать шаблон заполнения прайс-листа</span>
  </div>
</template>

<script>
import _ from "lodash";
import { read, utils, writeFile } from "xlsx";
import axios from "axios";
export default {
  name: "drag-and-drop",
  emits: [
    'basketUpdate'
  ],
  data() {
    return {
      file: null,
      scheme: null,
      result: [],
      example: [
        {
          'Наименование': 'Необходимое название товара',
          'Артикул': 111,
          'Количество': 14
        },
        {
          'Наименование': 'Необходимое название товара 2',
          'Артикул': 222,
          'Количество': 9
        },
      ]
    }
  },
  methods: {
    async onChange(event) {
      this.result = [];
      if(event.target.files[0] === null || event.target.files[0] === undefined){
        return
      }
      this.file = event.target.files[0];
      console.log(event);
      let rawFile = await this.file.arrayBuffer();
      let readedFile = read(rawFile)
      let val = Object.keys(readedFile.Sheets).map((key) => utils.sheet_to_json(readedFile.Sheets[key], {})).flat()
      val.forEach((el) => {
        this.result.push(_.values(el))
      });
      this.result = _.mapValues(this.result, function (o) {
        return {name: o[0], article: o[1], quantity: o[2]}
      })
      this.MultipleItemsAdd()
    },
    MultipleItemsAdd() {
      let params = {
        items: this.result
      }
      axios.post(`http://localhost:8080/BasketApi/MultipleItemsAdd`, params, {withCredentials: true})
          .then((response) => {
            if (response.data.status === 'success') {
              this.$emit('basketUpdate')
            } else {
              console.log(response.data)
            }
          })
    },
    DownloadExample() {
      /* generate worksheet and workbook */
      const worksheet = utils.json_to_sheet(this.example);
      const wscols = [{wch:30}, {wch:30}, {wch:30}];
      const workbook = utils.book_new();
      utils.book_append_sheet(workbook, worksheet, "Лист1");
      /* fix headers */
      utils.sheet_add_aoa(worksheet, [["Наименование", "Артикул", "Количество"]], {origin: "A1"});
      /* calculate column width */
      worksheet["!cols"] = wscols;
      /* create an XLSX file and try to save to xlsx */
      writeFile(workbook, "шаблон-заполнения.xlsx");
    }
  },
  computed: {

  }
}
</script>

<style scoped>
.dragAndDrop__wrapper{
  gap:20px;
  width: 100%;
  height: 100%;
  display: grid;
  grid-template-columns: repeat(auto-fill,minmax(min(320px, 100%), 1fr));
}
.dragAndDrop__block{
  padding: 40px 48px;
  display: flex;
  align-items: center;
  height: 100%;
  width: 100%;
  font-weight: 500;
  line-height: 120%;
}
.dragAndDrop__label{
  border: 2px dashed #898988;
}
.dragAndDrop__block svg{
  margin-right: 20px;
  width: 100%;
}
.dragAndDrop__input{
  top: 0;
  left: 0;
  display: flex;
  width: 100%;
  height: 100%;
  z-index: 1;
  opacity: 0;
}
.dragAndDrop__history-orders{
  width: 100%;
  height: 100%;
  display: flex;
  background: #EDF3F7;
}
.dragAndDrop__notice{
  font-style: italic;
  font-weight: 400;
  font-size: 14px;
  line-height: 120%;
  color: #898988;
}
.dragAndDrop__download-example{
  margin-left: 4px;
  font-style: italic;
  font-weight: 400;
  font-size: 14px;
  line-height: 120%;
  color: #C42A64;
}
</style>
